let lines=[];

term.addEventListener("keydown",async(e)=>{

  if(!selectedProgram || busy) return;

  // SHIFT+ENTER = new line input
  if(e.key==="Enter" && e.shiftKey){
    e.preventDefault();
    lines.push(inputBuffer);
    write("\n");
    inputBuffer="";
    return;
  }

  // ENTER = run
  if(e.key==="Enter"){
    e.preventDefault();

    lines.push(inputBuffer);

    const fullInput=lines.join("\n");

    write("\nRunning...\n");

    busy=true;

    const r=await fetch(API+"/run",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        filename:selectedProgram,
        input:fullInput
      })
    });

    const runid=await r.text();

    await new Promise(r=>setTimeout(r,6000));

    let status="queued";
    while(status!=="completed"){
      await new Promise(r=>setTimeout(r,5000));
      const s=await fetch(API+"/status?id="+runid);
      status=await s.text();
      write("status: "+status+"\n");
    }

    write("\n--- OUTPUT ---\n");

    let output="waiting...";
    while(output==="waiting..."){
      await new Promise(r=>setTimeout(r,3000));
      const out=await fetch(API+"/result?id="+runid);
      output=await out.text();
    }

    write(output+"\n");
    write("\n> ");

    inputBuffer="";
    lines=[];
    busy=false;
    return;
  }

  if(e.key==="Backspace"){
    e.preventDefault();
    if(inputBuffer.length>0){
      inputBuffer=inputBuffer.slice(0,-1);
      term.textContent=term.textContent.slice(0,-1);
    }
    return;
  }

  if(e.key.length===1){
    inputBuffer+=e.key;
    write(e.key);
  }

});
