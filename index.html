<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Java Runner</title>

<style>
body{
    font-family: Arial;
    text-align:center;
    margin-top:80px;
    background:#f2f2f2;
}

h1{
    margin-bottom:40px;
}

button{
    display:block;
    margin:15px auto;
    padding:14px 28px;
    font-size:18px;
    background:green;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
}

button:hover{
    background:#0a7a0a;
}

#status{
    margin-top:25px;
    font-size:18px;
}

pre{
    background:white;
    padding:18px;
    width:65%;
    margin:20px auto;
    border-radius:10px;
    text-align:left;
    box-shadow:0 0 10px rgba(0,0,0,0.15);
    white-space:pre-wrap;
    word-wrap:break-word;
}
</style>
</head>

<body>

<h1>Available Java Programs</h1>

<div id="programs"></div>
<div id="status">Loading programs...</div>

<script>

const API = "https://throbbing-glitter-9b1e.donthulanithish53.workers.dev";

async function loadPrograms(){

    const status = document.getElementById("status");
    const container = document.getElementById("programs");

    try{

        const res = await fetch(API + "/files", {
            method: "GET",
            mode: "cors",
            cache: "no-store",
            headers: { "Accept": "application/json" }
        });

        if(!res.ok){
            status.innerHTML = "Worker not responding (" + res.status + ")";
            return;
        }

        const files = await res.json();

        container.innerHTML = "";
        status.innerHTML = "";

        if(files.length === 0){
            status.innerHTML = "No Java programs found in repository.";
            return;
        }

        files.forEach(file => {

            const btn = document.createElement("button");
            btn.innerText = "Run " + file;

            btn.onclick = async () => {

                status.innerHTML = "Preparing to run " + file + "...";

                /* get old output */
                const oldRes = await fetch(API + "/result?cache=" + Date.now(), {cache:"no-store"});
                const oldOutput = await oldRes.text();

                /* start GitHub Action */
                await fetch(API + "/run", {
                    method:"POST",
                    mode:"cors",
                    headers:{"Content-Type":"application/json"},
                    body: JSON.stringify({ filename:file })
                });

                status.innerHTML = "Running " + file + " on GitHub runner... please wait";

                let newOutput = oldOutput;

                /* wait until output changes */
                for(let i=0;i<24;i++){   // up to 2 minutes

                    await new Promise(r => setTimeout(r, 5000));

                    const res = await fetch(API + "/result?cache=" + Date.now(), {cache:"no-store"});
                    newOutput = await res.text();

                    if(newOutput !== oldOutput){
                        break;
                    }
                }

                status.innerHTML =
                    "<h3>Program Output:</h3><pre>"+newOutput+"</pre>";
            };

            container.appendChild(btn);
        });

    }catch(err){
        status.innerHTML = "Cannot connect to Worker API";
        console.error(err);
    }
}

loadPrograms();

</script>

</body>
</html>
