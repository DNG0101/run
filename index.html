<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Java Cloud Terminal</title>

<style>
body{
  background:#111;
  color:#0f0;
  font-family:Consolas,monospace;
  text-align:center;
}
#console{
  width:85%;
  height:470px;
  margin:20px auto;
  background:black;
  padding:15px;
  overflow:auto;
  white-space:pre-wrap;
  border-radius:8px;
  text-align:left;
  border:2px solid #0f0;
  outline:none;
}
button{
  padding:10px 18px;
  margin:5px;
  font-size:15px;
  background:#222;
  color:#0f0;
  border:1px solid #0f0;
  cursor:pointer;
}
button:hover{background:#333}
</style>
</head>

<body>

<h2>Java Cloud Terminal</h2>
<div id="programs"></div>
<div id="console" tabindex="0"></div>

<script>

const API="https://throbbing-glitter-9b1e.donthulanithish53.workers.dev";
const term=document.getElementById("console");

let busy=false;
let selectedProgram=null;

let currentLine="";
let lines=[];

function write(t){
  term.textContent+=t;
  term.scrollTop=term.scrollHeight;
}

/* load available .java files */
async function loadPrograms(){
  const r=await fetch(API+"/files");
  const files=await r.json();
  const box=document.getElementById("programs");

  files.forEach(f=>{
    const b=document.createElement("button");
    b.textContent=f;
    b.onclick=()=>{
      selectedProgram=f;
      term.textContent="";
      write("Selected: "+f+"\n");
      write("SHIFT+ENTER → next input line\nENTER → run program\n\n> ");
      term.focus();
    };
    box.appendChild(b);
  });
}

/* terminal keyboard */
term.addEventListener("keydown",async(e)=>{

  if(!selectedProgram || busy) return;

  /* SHIFT+ENTER → new input line */
  if(e.key==="Enter" && e.shiftKey){
    e.preventDefault();
    lines.push(currentLine);
    write("\n> ");
    currentLine="";
    return;
  }

  /* ENTER → run program */
  if(e.key==="Enter"){
    e.preventDefault();

    lines.push(currentLine);
    const fullInput=lines.join("\n");

    write("\nRunning...\n");
    busy=true;

    const r=await fetch(API+"/run",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        filename:selectedProgram,
        input:fullInput
      })
    });

    const runid=await r.text();

    /* wait for runner */
    let status="queued";
    while(status!=="completed"){
      await new Promise(r=>setTimeout(r,5000));
      const s=await fetch(API+"/status?id="+runid);
      status=await s.text();
      write("status: "+status+"\n");
    }

    /* wait for output file */
    write("\nFetching output...\n");

    let output="waiting...";
    while(output==="waiting..."){
      await new Promise(r=>setTimeout(r,3000));
      const out=await fetch(API+"/result?id="+runid);
      output=await out.text();
    }

    write("\n--- OUTPUT ---\n");
    write(output+"\n\n> ");

    currentLine="";
    lines=[];
    busy=false;
    return;
  }

  /* BACKSPACE */
  if(e.key==="Backspace"){
    e.preventDefault();
    if(currentLine.length>0){
      currentLine=currentLine.slice(0,-1);
      term.textContent=term.textContent.slice(0,-1);
    }
    return;
  }

  /* normal typing */
  if(e.key.length===1){
    currentLine+=e.key;
    write(e.key);
  }
});

loadPrograms();

</script>
</body>
</html>
