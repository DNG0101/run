<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Java Cloud IDE</title>

<style>
body{
  margin:0;
  background:#0c0c0c;
  color:#00ff9c;
  font-family:Consolas,monospace;
}

#layout{
  display:flex;
  height:100vh;
}

/* LEFT */
#left{
  width:50%;
  border-right:2px solid #00ff9c;
  padding:12px;
  box-sizing:border-box;
}

#code{
  white-space:pre;
  height:90%;
  overflow:auto;
  color:#00eaff;
}

/* RIGHT */
#right{
  width:50%;
  display:flex;
  flex-direction:column;
}

#programs{
  border-bottom:2px solid #00ff9c;
  padding:10px;
}

button{
  padding:6px 12px;
  margin:4px;
  background:#111;
  color:#00ff9c;
  border:1px solid #00ff9c;
  cursor:pointer;
}
button:hover{background:#1c1c1c}

/* terminal */
#term{
  flex:1;
  background:black;
  padding:12px;
  overflow:auto;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<div id="layout">

  <div id="left">
    <h3>Java Source</h3>
    <pre id="code">Loading programs...</pre>
  </div>

  <div id="right">
    <div id="programs"></div>
    <div id="term" tabindex="0"></div>
  </div>

</div>

<script>

const API="https://throbbing-glitter-9b1e.donthulanithish53.workers.dev";

const term=document.getElementById("term");
const code=document.getElementById("code");

function write(t){
  term.textContent+=t;
  term.scrollTop=term.scrollHeight;
}

async function loadPrograms(){

  const r=await fetch(API+"/files");
  if(!r.ok){
    code.textContent="Server unreachable";
    return;
  }

  const files=await r.json();
  const box=document.getElementById("programs");
  box.innerHTML="";

  files.forEach(f=>{
    const b=document.createElement("button");
    b.textContent=f;

    b.onclick=()=>runProgram(f);
    box.appendChild(b);
  });

  code.textContent="Select a program to view and run.";
}

async function runProgram(file){

  term.textContent="";
  write("Fetching code...\n");

  const r=await fetch(API+"/code?file="+file);
  const src=await r.text();
  code.textContent=src;

  /* collect inputs automatically */
  const inputCount=(src.match(/next(Int|Line|Double|Float|Long|)/g)||[]).length;

  let inputs=[];
  for(let i=1;i<=inputCount;i++){
    const val=prompt("Input "+i+":")||"";
    inputs.push(val);
  }

  const fullInput=inputs.join("\n");

  write("Starting execution...\n");

  const run=await fetch(API+"/run",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({filename:file,input:fullInput})
  });

  const runid=await run.text();
  write("Run ID: "+runid+"\n");

  /* status polling */
  let completed=false;

  while(!completed){
    await new Promise(r=>setTimeout(r,4000));

    const s=await fetch(API+"/status?id="+runid);
    const js=await s.json();

    write("status: "+js.status+"\n");

    if(js.conclusion==="failure"){
      write("Program failed (compile/runtime error)\n");
      return;
    }

    if(js.status==="completed")
      completed=true;
  }

  write("\nFetching output...\n");

  let output="waiting";
  while(output==="waiting"){
    await new Promise(r=>setTimeout(r,3000));
    const out=await fetch(API+"/result?id="+runid);
    output=await out.text();
  }

  write("\n----- OUTPUT -----\n");
  write(output+"\n");
}

loadPrograms();

</script>
</body>
</html>
