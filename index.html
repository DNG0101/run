<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Java Cloud IDE</title>

<style>
body{
  margin:0;
  background:#0b0f0b;
  color:#00ffa2;
  font-family:Consolas,monospace;
}

#layout{
  display:flex;
  height:100vh;
}

#left{
  width:50%;
  border-right:2px solid #00ffa2;
  padding:12px;
  box-sizing:border-box;
  overflow:auto;
}

#right{
  width:50%;
  display:flex;
  flex-direction:column;
}

#programs{
  padding:10px;
  border-bottom:2px solid #00ffa2;
}

#code{
  white-space:pre;
  color:#00eaff;
}

button{
  padding:6px 14px;
  margin:4px;
  background:#111;
  color:#00ffa2;
  border:1px solid #00ffa2;
  cursor:pointer;
}
button:hover{background:#1c1c1c}

/* manual input box */
#manualInput{
  width:100%;
  height:120px;
  background:black;
  color:#00ffa2;
  border:none;
  border-top:2px solid #00ffa2;
  padding:10px;
  font-family:Consolas,monospace;
  resize:none;
  outline:none;
}

/* run button */
#runBtn{
  background:#003b2b;
  border:none;
  color:#00ffa2;
  padding:10px;
  font-weight:bold;
}
#runBtn:hover{background:#005f45}

#term{
  flex:1;
  padding:12px;
  background:black;
  overflow:auto;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<div id="layout">
  <div id="left">
    <h3>Java Source</h3>
    <pre id="code">Connecting to server...</pre>
  </div>

  <div id="right">
    <div id="programs"></div>

    <textarea id="manualInput" placeholder="Optional input (for args[] or competitive programs)
Example:
5 10
or
3
1 2 3"></textarea>

    <button id="runBtn">RUN</button>

    <div id="term"></div>
  </div>
</div>

<script>

const API="https://throbbing-glitter-9b1e.donthulanithish53.workers.dev";

const term=document.getElementById("term");
const code=document.getElementById("code");
const programs=document.getElementById("programs");
const manualInput=document.getElementById("manualInput");
const runBtn=document.getElementById("runBtn");

let selectedFile=null;
let lastPrompts=[];

function write(t){
  term.textContent+=t;
  term.scrollTop=term.scrollHeight;
}

/* -------- PROMPT DETECTOR -------- */
function extractPrompts(code){
  const prompts=[];
  const regex=/System\.out\.print(?:ln)?\s*\(\s*"(.*?)"\s*\)/g;

  let match;
  while((match=regex.exec(code))!==null){
    const text=match[1].trim();
    if(text.length>0) prompts.push(text);
  }
  return prompts;
}

/* -------- CLEAN OUTPUT -------- */
function cleanOutput(output,prompts){

  let cleaned=output;

  // remove github footer
  cleaned=cleaned.replace(/RUN:\d+/g,"");

  // remove printed prompts
  for(const p of prompts){
    const escaped=p.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const regex=new RegExp(escaped,"g");
    cleaned=cleaned.replace(regex,"");
  }

  return cleaned.trim();
}

/* -------- LOAD FILES -------- */
async function loadPrograms(){

  const r=await fetch(API+"/files");
  const files=await r.json();

  programs.innerHTML="";

  files.forEach(f=>{
    const b=document.createElement("button");
    b.textContent=f;

    b.onclick=async ()=>{
      selectedFile=f;
      term.textContent="";
      write("Loading "+f+"...\n");

      const r2=await fetch(API+"/code?file="+encodeURIComponent(f));
      const src=await r2.text();
      code.textContent=src;

      lastPrompts=extractPrompts(src);

      if(lastPrompts.length>0)
        write("Program requires interactive input.\n");
      else
        write("Paste input in the box and press RUN.\n");
    };

    programs.appendChild(b);
  });

  code.textContent="Select a program from the right.";
}

/* -------- RUN PROGRAM -------- */
runBtn.onclick=async function(){

  if(!selectedFile){
    alert("Select a program first");
    return;
  }

  let inputs=[];

  /* If prompts exist â†’ popup input */
  if(lastPrompts.length>0){
    for(const p of lastPrompts){
      const val=prompt(p) ?? "";
      inputs.push(val);
    }
  }
  else{
    // manual input box
    inputs=manualInput.value.split("\n");
  }

  term.textContent="";
  write("Starting execution...\n");

  const start=await fetch(API+"/run",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      filename:selectedFile,
      input:inputs.join("\n")
    })
  });

  const runid=await start.text();
  write("Run ID: "+runid+"\n");

  let done=false;
  while(!done){
    await new Promise(r=>setTimeout(r,4000));
    const s=await fetch(API+"/status?id="+runid);
    const js=await s.json();

    write("status: "+js.status+"\n");
    if(js.status==="completed") done=true;
  }

  write("\nFetching output...\n");

  let output="waiting";
  while(output==="waiting"){
    await new Promise(r=>setTimeout(r,3000));
    const out=await fetch(API+"/result?id="+runid);
    output=await out.text();
  }

  output=cleanOutput(output,lastPrompts);

  write("\n------ OUTPUT ------\n");
  write(output+"\n");
};

loadPrograms();

</script>
</body>
</html>
