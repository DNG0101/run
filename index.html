<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Java Cloud IDE</title>

<style>
body{
  background:#111;
  color:#0f0;
  font-family:Consolas,monospace;
  margin:0;
}

/* layout */
#container{
  display:flex;
  height:100vh;
}

/* LEFT: code viewer */
#codePanel{
  width:50%;
  border-right:2px solid #0f0;
  padding:15px;
  box-sizing:border-box;
  overflow:auto;
  background:#0b0b0b;
}

#codePanel h3{
  margin-top:0;
  color:#00ffaa;
}

#code{
  white-space:pre;
  text-align:left;
  color:#00eaff;
}

/* RIGHT: terminal */
#rightPanel{
  width:50%;
  display:flex;
  flex-direction:column;
}

#programs{
  padding:10px;
  border-bottom:2px solid #0f0;
}

button{
  padding:8px 14px;
  margin:4px;
  font-size:14px;
  background:#222;
  color:#0f0;
  border:1px solid #0f0;
  cursor:pointer;
}
button:hover{background:#333}

#console{
  flex:1;
  padding:15px;
  background:black;
  overflow:auto;
  white-space:pre-wrap;
  outline:none;
}
</style>
</head>

<body>

<div id="container">

  <div id="codePanel">
    <h3>Program Code</h3>
    <pre id="code">Select a program...</pre>
  </div>

  <div id="rightPanel">
    <div id="programs"></div>
    <div id="console" tabindex="0"></div>
  </div>

</div>

<script>

const API="https://throbbing-glitter-9b1e.donthulanithish53.workers.dev";

const term=document.getElementById("console");
const codeBox=document.getElementById("code");

let busy=false;
let selectedProgram=null;
let lastPrompts=[];

let currentLine="";
let lines=[];

/* write to terminal */
function write(t){
  term.textContent+=t;
  term.scrollTop=term.scrollHeight;
}

/* detect input count */
function countInputs(code){
  const patterns=[
    "nextInt(",
    "nextLine(",
    "nextDouble(",
    "nextFloat(",
    "next(",
    "nextLong("
  ];

  let count=0;
  patterns.forEach(p=>{
    count+=code.split(p).length-1;
  });

  return count;
}

/* extract real prompts from java */
function extractPrompts(code){

  const prompts=[];
  const regex=/System\.out\.print(?:ln)?\s*\(\s*"(.*?)"\s*\)/g;

  let match;
  while((match=regex.exec(code))!==null){
    prompts.push(match[1]);
  }
  return prompts;
}

/* remove prompts from output */
function cleanOutput(output, prompts){

  let cleaned=output;

  for(let p of prompts){
    const escaped=p.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const regex=new RegExp(escaped,"g");
    cleaned=cleaned.replace(regex,"");
  }

  return cleaned.trim();
}

/* load java files */
async function loadPrograms(){

  const r=await fetch(API+"/files");
  const files=await r.json();
  const box=document.getElementById("programs");

  files.forEach(f=>{

    const b=document.createElement("button");
    b.textContent=f;

    b.onclick=async ()=>{

      selectedProgram=f;

      /* load source code */
      const r2=await fetch(API+"/code?file="+f);
      const code=await r2.text();
      codeBox.textContent=code;

      /* get prompts */
      const prompts=extractPrompts(code);
      lastPrompts=prompts;

      let collected=[];

      if(prompts.length>0){

        for(let p of prompts){
          const val=prompt(p.trim());
          collected.push(val??"");
        }

      }else{

        const totalInputs=countInputs(code);

        for(let i=1;i<=totalInputs;i++){
          const val=prompt("Enter input value "+i+":");
          collected.push(val??"");
        }
      }

      lines=collected;

      /* reset console */
      term.textContent="";
      write("Selected: "+f+"\n");
      write("Inputs captured. Press ENTER to run.\n\n> ");
      term.focus();
    };

    box.appendChild(b);
  });
}

/* terminal keyboard */
term.addEventListener("keydown",async(e)=>{

  if(!selectedProgram || busy) return;

  /* SHIFT+ENTER new line */
  if(e.key==="Enter" && e.shiftKey){
    e.preventDefault();
    lines.push(currentLine);
    write("\n> ");
    currentLine="";
    return;
  }

  /* ENTER run */
  if(e.key==="Enter"){
    e.preventDefault();

    lines.push(currentLine);
    const fullInput=lines.join("\n");

    write("\nRunning...\n");
    busy=true;

    const r=await fetch(API+"/run",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        filename:selectedProgram,
        input:fullInput
      })
    });

    const runid=await r.text();

    /* wait runner */
    let status="queued";
    while(status!=="completed"){
      await new Promise(r=>setTimeout(r,5000));
      const s=await fetch(API+"/status?id="+runid);
      status=await s.text();
      write("status: "+status+"\n");
    }

    write("\nFetching output...\n");

    let output="waiting...";
    let tries=0;

    while(tries<20){
      await new Promise(r=>setTimeout(r,3000));
      const out=await fetch(API+"/result?id="+runid);
      output=await out.text();

      if(output!=="waiting..." && output.trim()!=="")
        break;

      tries++;
    }

    /* CLEAN PROMPTS */
    output=cleanOutput(output,lastPrompts);

    write("\n----- PROGRAM OUTPUT -----\n");
    write(output+"\n\n> ");

    currentLine="";
    lines=[];
    busy=false;
    return;
  }

  /* BACKSPACE */
  if(e.key==="Backspace"){
    e.preventDefault();
    if(currentLine.length>0){
      currentLine=currentLine.slice(0,-1);
      term.textContent=term.textContent.slice(0,-1);
    }
    return;
  }

  /* typing */
  if(e.key.length===1){
    currentLine+=e.key;
    write(e.key);
  }
});

loadPrograms();

</script>
</body>
</html>
