<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Java Cloud IDE</title>

<style>
body{
  margin:0;
  background:#0b0f0b;
  color:#00ffa2;
  font-family:Consolas,monospace;
}

#layout{
  display:flex;
  height:100vh;
}

#left{
  width:50%;
  border-right:2px solid #00ffa2;
  padding:12px;
  box-sizing:border-box;
  overflow:auto;
}

#right{
  width:50%;
  display:flex;
  flex-direction:column;
}

#programs{
  padding:10px;
  border-bottom:2px solid #00ffa2;
}

#code{
  white-space:pre;
  color:#00eaff;
}

button{
  padding:6px 14px;
  margin:4px;
  background:#111;
  color:#00ffa2;
  border:1px solid #00ffa2;
  cursor:pointer;
}
button:hover{background:#1c1c1c}

#term{
  flex:1;
  padding:12px;
  background:black;
  overflow:auto;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<div id="layout">
  <div id="left">
    <h3>Java Source</h3>
    <pre id="code">Connecting to server...</pre>
  </div>

  <div id="right">
    <div id="programs"></div>
    <div id="term"></div>
  </div>
</div>

<script>

const API="https://throbbing-glitter-9b1e.donthulanithish53.workers.dev";
const term=document.getElementById("term");
const code=document.getElementById("code");
const programs=document.getElementById("programs");

function write(t){
  term.textContent+=t;
  term.scrollTop=term.scrollHeight;
}

/* ---------------- EXTRACT PROMPTS FROM JAVA ---------------- */
function extractPrompts(code){
  const prompts=[];
  const regex=/System\.out\.print(?:ln)?\s*\(\s*"(.*?)"\s*\)/g;

  let match;
  while((match=regex.exec(code))!==null){
    const text=match[1].trim();
    if(text.length>0)
      prompts.push(text);
  }

  return prompts;
}

/* ---------------- REMOVE PROMPTS FROM OUTPUT ---------------- */
function cleanOutput(output, prompts){

  let cleaned=output;

  // remove RUN: footer
  cleaned=cleaned.replace(/RUN:\d+/g,"");

  // remove prompts printed by Java
  for(const p of prompts){
    const escaped=p.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const regex=new RegExp(escaped,"g");
    cleaned=cleaned.replace(regex,"");
  }

  // remove extra spaces/newlines
  cleaned=cleaned.replace(/\n\s*\n/g,"\n").trim();

  return cleaned;
}

/* ---------------- LOAD PROGRAM LIST ---------------- */
async function loadPrograms(){

  const r=await fetch(API+"/files");
  if(!r.ok){
    code.textContent="Worker unreachable.";
    return;
  }

  const files=await r.json();
  programs.innerHTML="";

  files.forEach(f=>{
    const b=document.createElement("button");
    b.textContent=f;
    b.onclick=()=>runProgram(f);
    programs.appendChild(b);
  });

  code.textContent="Select a program from the right.";
}

/* ---------------- RUN PROGRAM ---------------- */
async function runProgram(file){

  term.textContent="";
  write("Fetching code...\n");

  const r=await fetch(API+"/code?file="+encodeURIComponent(file));
  const src=await r.text();
  code.textContent=src;

  let inputs=[];
  const prompts=extractPrompts(src);

  /* If program contains prompts, use them */
  if(prompts.length>0){
    for(const p of prompts){
      const val=prompt(p.trim()) ?? "";
      inputs.push(val);
    }
  }
  else{
    // fallback for programs without prints
    const matches = src.match(/next(Int|Line|Double|Float|Long|Short|Byte)\s*\(/g);
    const count = matches ? matches.length : 0;

    for(let i=1;i<=count;i++){
      const val=prompt("Enter input "+i+":") ?? "";
      inputs.push(val);
    }
  }

  write("Starting execution...\n");

  const start=await fetch(API+"/run",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      filename:file,
      input:inputs.join("\n")
    })
  });

  const runid=await start.text();
  write("Run ID: "+runid+"\n");

  /* wait for runner */
  let done=false;
  while(!done){
    await new Promise(r=>setTimeout(r,4000));
    const s=await fetch(API+"/status?id="+runid);
    const js=await s.json();

    write("status: "+js.status+"\n");

    if(js.conclusion==="failure"){
      write("\nProgram failed.\n");
      return;
    }

    if(js.status==="completed")
      done=true;
  }

  write("\nFetching output...\n");

  let output="waiting";
  while(output==="waiting"){
    await new Promise(r=>setTimeout(r,3000));
    const out=await fetch(API+"/result?id="+runid);
    output=await out.text();
  }

  /* CLEAN OUTPUT HERE */
  output=cleanOutput(output,prompts);

  write("\n------ OUTPUT ------\n");
  write(output+"\n");
}

loadPrograms();
</script>
</body>
</html>
